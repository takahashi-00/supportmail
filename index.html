<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アフター点検メール作成ツール</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans JP', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'bounce-slight': 'bounceSlight 2s infinite',
                        'pulse-fast': 'pulseFast 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' },
                        },
                        pulseFast: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #f472b6; /* pink-400 */
            box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.2);
        }
        
        .bg-animate {
            background-size: 200% 200%;
            animation: gradientBG 20s ease infinite;
            transition: background-image 0.8s ease-in-out;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* macOS Window Buttons */
        .mac-dot { 
            width: 12px; 
            height: 12px; 
            min-width: 12px;
            min-height: 12px;
            border-radius: 50%; 
            display: block; 
            position: relative; 
            margin-right: 6px; 
            flex-shrink: 0;
        }
        .mac-close { background-color: #FF5F56; border: 0.5px solid #E0443E; }
        .mac-minimize { background-color: #FFBD2E; border: 0.5px solid #DEA123; }
        .mac-maximize { background-color: #27C93F; border: 0.5px solid #1AAB29; }
    </style>
</head>
<body id="bodyBg" class="bg-gradient-to-br from-pink-300 via-purple-300 to-cyan-300 dark:from-slate-900 dark:via-purple-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-pink-400 selection:text-white bg-animate">

    <!-- 設定モーダル -->
    <div id="settingsModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleSettingsModal()"></div>
        <div class="relative w-full max-w-md bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-6 border border-white/50 dark:border-slate-700 animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-black text-slate-700 dark:text-white flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5 text-pink-500"></i>
                    AI設定
                </h3>
                <button onclick="toggleSettingsModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="space-y-1.5">
                    <div class="flex justify-between items-end">
                        <label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Gemini API Key</label>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-[10px] text-pink-500 hover:text-pink-600 hover:underline flex items-center gap-1 transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i>
                            キーを取得する
                        </a>
                    </div>
                    <input type="password" id="apiKeyInput" placeholder="AIzaSy..." 
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all focus:ring-2 focus:ring-pink-500/20">
                    <p class="text-[10px] text-slate-400">キーはブラウザにのみ保存され、外部に送信されることはありません。</p>
                </div>

                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Model Name</label>
                    <input type="text" id="modelNameInput" value="gemini-3-flash-preview"
                        class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all focus:ring-2 focus:ring-pink-500/20">
                    <p class="text-[10px] text-slate-400">思考レベル有効 (Gemini 3 Flash Preview)</p>
                </div>
            </div>

            <div class="mt-8 flex gap-3">
                <button onclick="saveSettings()" class="flex-1 bg-gradient-to-r from-pink-500 to-violet-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-pink-500/30 hover:shadow-pink-500/40 active:scale-95 transition-all">
                    設定を保存
                </button>
                <button onclick="clearSettings()" class="px-4 py-3.5 text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-xl transition-all font-bold text-sm">
                    削除
                </button>
            </div>
        </div>
    </div>

    <!-- 通知用トースト -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 z-[110] hidden animate-fade-in">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 border border-white/20 backdrop-blur-md">
            <i data-lucide="info" class="w-4 h-4 text-pink-400"></i>
            <span id="toastText" class="text-sm font-bold">通知メッセージ</span>
        </div>
    </div>

    <!-- ヘッダー -->
    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-white/40 dark:border-slate-700/50 sticky top-0 z-50 shadow-sm transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-pink-500 to-violet-500 p-2.5 rounded-2xl text-white shadow-lg shadow-pink-500/30 transform transition-transform hover:scale-110 hover:rotate-3 duration-300">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-600 to-violet-600 dark:from-pink-400 dark:to-violet-400 tracking-tight leading-none">After Support Mailer</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-bold mt-1 tracking-wide">桧家住宅 埼玉北工事部</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- 設定ボタン -->
                <button onclick="toggleSettingsModal()" class="p-2.5 rounded-full text-slate-500 hover:text-slate-600 dark:hover:text-slate-200">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
                <!-- ダークモード切替 -->
                <button onclick="toggleDarkMode()" class="p-2.5 rounded-full text-slate-500 hover:text-violet-600 dark:text-slate-400 dark:hover:text-violet-300 hover:bg-white/60 dark:hover:bg-slate-700 transition-all focus:outline-none focus:ring-2 focus:ring-violet-400/50 active:scale-95" title="テーマ切替">
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                </button>
                <!-- リセット -->
                <button onclick="resetForm()" class="p-2.5 rounded-full text-slate-500 hover:text-rose-500 hover:bg-rose-50 dark:text-slate-400 dark:hover:bg-rose-900/20 transition-all focus:outline-none focus:ring-2 focus:ring-rose-400/50 active:scale-95" title="リセット">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 lg:py-10 space-y-6">

        <!-- モード切り替えタブ -->
        <nav class="grid grid-cols-3 gap-2 sm:gap-4">
            <!-- AI文章作成 -->
            <button onclick="setMode('custom')" id="tabCustom" class="group relative flex flex-col items-center justify-center py-3 rounded-xl border transition-all duration-200 font-bold shadow-sm">
                <div class="flex items-center gap-1.5">
                    <i data-lucide="sparkles" class="w-4 h-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-pink-500 stroke-pink-500"></i>
                    <span class="text-sm bg-gradient-to-r from-blue-600 to-pink-600 bg-clip-text text-transparent group-hover:from-blue-500 group-hover:to-pink-500">AI文章作成</span>
                </div>
            </button>
            <!-- 日程調整メール -->
            <button onclick="setMode('normal')" id="tabNormal" class="group relative flex flex-col items-center justify-center py-3 rounded-xl border transition-all duration-200 font-bold shadow-sm">
                <span class="text-sm">日程調整メール</span>
            </button>
            <!-- 事前確認SMS -->
            <button onclick="setMode('sms')" id="tabSms" class="group relative flex flex-col items-center justify-center py-3 rounded-xl border transition-all duration-200 font-bold shadow-sm">
                <span class="text-sm">事前確認SMS</span>
            </button>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- 左カラム：入力フォーム -->
            <div class="lg:col-span-7 space-y-6">
                
                <!-- 共通：基本情報（常に表示） -->
                <div class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                    <div class="bg-gradient-to-r from-pink-50/80 to-purple-50/80 dark:from-pink-900/20 dark:to-purple-900/20 px-6 py-4 border-b border-pink-100/50 dark:border-pink-800/30 flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-pink-100 dark:bg-pink-900/50 flex items-center justify-center text-pink-500 dark:text-pink-300">
                            <i data-lucide="user-circle" class="w-5 h-5"></i>
                        </div>
                        <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">基本情報設定</h2>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- 顧客名 -->
                            <div class="space-y-1.5">
                                <label class="text-xs font-bold text-pink-500/80 dark:text-pink-400/80 uppercase tracking-wider ml-1">顧客名 <span class="text-rose-500">*</span></label>
                                <div class="relative group">
                                    <i data-lucide="user" class="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 w-5 h-5 group-focus-within:text-pink-500 transition-colors"></i>
                                    <input type="text" id="customerName" placeholder="例：山田 太郎" 
                                        class="w-full pl-10 pr-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all placeholder:text-slate-400 shadow-sm focus:bg-white dark:focus:bg-slate-700"
                                        oninput="updatePreview()">
                                </div>
                            </div>

                            <!-- 担当者名 -->
                            <div class="space-y-1.5">
                                <label class="text-xs font-bold text-purple-500/80 dark:text-purple-400/80 uppercase tracking-wider ml-1">担当者名 <span class="text-rose-500">*</span></label>
                                <div class="relative group">
                                    <i data-lucide="briefcase" class="absolute left-3 top-2.5 text-slate-400 dark:text-slate-500 w-5 h-5 group-focus-within:text-purple-500 transition-colors"></i>
                                    <input type="text" id="staffName" value="畑" placeholder="担当者名"
                                        class="w-full pl-10 pr-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all shadow-sm focus:bg-white dark:focus:bg-slate-700"
                                        oninput="updatePreview()">
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- モード別入力エリアのコンテナ -->
                <div id="modeSettingsContainer" class="space-y-6">
                    
                    <!-- 1. 通常・事前確認モード用設定 (デフォルト表示) -->
                    <div id="normalSettings" class="space-y-6 animate-fade-in">
                        
                        <!-- 点検詳細カード (SMSモード時は非表示) -->
                        <div id="inspectionDetailsCard" class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                            <div class="bg-gradient-to-r from-blue-50/80 to-cyan-50/80 dark:from-blue-900/20 dark:to-cyan-900/20 px-6 py-4 border-b border-blue-100/50 dark:border-blue-800/30 flex items-center justify-between">
                                 <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center text-blue-500 dark:text-blue-300">
                                        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                                    </div>
                                    <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">点検・不具合詳細</h2>
                                </div>
                                <span class="text-[10px] bg-white/80 dark:bg-slate-700 px-2 py-1 rounded-full text-slate-500 dark:text-slate-300 font-bold border border-slate-100 dark:border-slate-600">定型モード</span>
                            </div>
                            
                            <div class="p-6 space-y-6">
                                <!-- 点検種別 -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-blue-500/80 dark:text-blue-400/80 uppercase tracking-wider ml-1">点検種別</label>
                                    <div class="relative">
                                        <select id="inspectionType" class="w-full px-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white appearance-none cursor-pointer transition-all focus:bg-white dark:focus:bg-slate-700 shadow-sm"
                                            onchange="toggleCustomInspection(); updatePreview()">
                                            <option value="6か月">6か月点検</option>
                                            <option value="2年">2年点検</option>
                                            <option value="その他">その他（手入力）</option>
                                        </select>
                                        <div class="absolute right-3 top-3 pointer-events-none text-slate-400">
                                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                        </div>
                                    </div>
                                    <div id="customInspectionWrapper" class="hidden mt-2">
                                        <input type="text" id="customInspectionType" placeholder="例：1年点検、臨時点検など"
                                            class="w-full px-4 py-2.5 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white transition-all"
                                            oninput="updatePreview()">
                                    </div>
                                </div>

                                <!-- 不具合内容 -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-amber-500/80 dark:text-amber-400/80 uppercase tracking-wider ml-1">不具合・指摘内容</label>
                                    <div class="relative group">
                                        <i data-lucide="alert-triangle" class="absolute left-3 top-3 text-slate-400 dark:text-slate-500 w-5 h-5 group-focus-within:text-amber-500 transition-colors"></i>
                                        <textarea id="issueDetail" placeholder="例：クロスの剥がれ、建具の調整" rows="3"
                                            class="w-full pl-10 pr-4 py-2.5 bg-white/50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-800 dark:text-white resize-none transition-all focus:bg-white dark:focus:bg-slate-700 shadow-sm"
                                            oninput="updatePreview()"></textarea>
                                    </div>
                                </div>

                                <!-- お詫びフラグ -->
                                <div class="flex items-center justify-between bg-orange-50/60 dark:bg-orange-900/20 p-3 rounded-xl border border-orange-100 dark:border-orange-800/30 transition-colors hover:bg-orange-50 dark:hover:bg-orange-900/30 group cursor-pointer" onclick="document.getElementById('needsApology').click()">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-white dark:bg-orange-900/40 p-2 rounded-lg text-orange-500 dark:text-orange-400 shadow-sm">
                                            <i data-lucide="heart-handshake" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-orange-900 dark:text-orange-200">お詫び文を挿入</div>
                                            <div class="text-xs text-orange-700/70 dark:text-orange-300/60">遅延時などに使用</div>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer pointer-events-none">
                                        <input type="checkbox" id="needsApology" class="sr-only peer" onchange="updatePreview()">
                                        <div class="w-10 h-6 bg-slate-300 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:shadow-sm after:transition-all peer-checked:bg-orange-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 訪問・日程調整カード -->
                        <div class="bg-white/70 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-xl shadow-purple-500/5 dark:shadow-black/40 border border-white/60 dark:border-slate-700/50 overflow-hidden transition-all duration-300 hover:shadow-purple-500/10">
                            <div class="bg-gradient-to-r from-emerald-50/80 to-teal-50/80 dark:from-emerald-900/20 dark:to-teal-900/20 px-6 py-4 border-b border-emerald-100/50 dark:border-emerald-800/30 flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex items-center justify-center text-emerald-500 dark:text-emerald-300">
                                    <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                                </div>
                                <h2 class="text-base font-bold text-slate-700 dark:text-slate-200">訪問・日程調整</h2>
                            </div>

                            <div class="p-6 space-y-6">
                                <!-- 訪問理由 -->
                                <div class="space-y-1.5">
                                    <label class="text-xs font-bold text-emerald-500/80 dark:text-emerald-400/80 uppercase tracking-wider ml-1">訪問理由</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="cursor-pointer relative">
                                            <input type="radio" name="visitReason" value="修繕作業" checked class="peer hidden" onchange="updatePreview()">
                                            <div class="text-center py-3 px-4 rounded-xl border-2 transition-all duration-200 bg-white/50 dark:bg-slate-700/50 border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 peer-checked:bg-blue-50/90 dark:peer-checked:bg-blue-900/40 peer-checked:border-blue-500 dark:peer-checked:border-blue-400 peer-checked:text-blue-600 dark:peer-checked:text-blue-300 peer-checked:font-bold peer-checked:shadow-sm hover:border-slate-300 dark:hover:border-slate-500 flex items-center justify-center gap-2">
                                                <i data-lucide="wrench" class="w-4 h-4"></i> 修繕作業
                                            </div>
                                        </label>
                                        <label class="cursor-pointer relative">
                                            <input type="radio" name="visitReason" value="現地調査" class="peer hidden" onchange="updatePreview()">
                                            <div class="text-center py-3 px-4 rounded-xl border-2 transition-all duration-200 bg-white/50 dark:bg-slate-700/50 border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 peer-checked:bg-emerald-50/90 dark:peer-checked:bg-emerald-900/40 peer-checked:border-emerald-500 dark:peer-checked:border-emerald-400 peer-checked:text-emerald-600 dark:peer-checked:text-emerald-300 peer-checked:font-bold peer-checked:shadow-sm hover:border-slate-300 dark:hover:border-slate-500 flex items-center justify-center gap-2">
                                                <i data-lucide="search" class="w-4 h-4"></i> 現地調査
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- 候補日入力エリア -->
                                <div class="space-y-1.5">
                                    <div class="flex justify-between items-end mb-1">
                                        <label class="text-xs font-bold text-emerald-500/80 dark:text-emerald-400/80 uppercase tracking-wider ml-1">日時設定</label>
                                        <button onclick="clearCandidates()" id="clearBtn" class="hidden text-xs text-rose-400 hover:text-rose-600 flex items-center gap-1 transition-colors px-2 py-1 rounded hover:bg-rose-50 dark:hover:bg-rose-900/20 font-bold">
                                            <i data-lucide="trash-2" class="w-3 h-3"></i> クリア
                                        </button>
                                    </div>
                                    
                                    <!-- カレンダーツール（15分刻み＋終了時間オプション） -->
                                    <div class="flex flex-wrap items-end gap-2 mb-3 p-3 bg-white/50 dark:bg-slate-700/30 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm">
                                        <div class="flex-1 min-w-[130px]">
                                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 mb-1 block uppercase">日付</label>
                                            <input type="date" id="dateInput" class="w-full px-3 py-2 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg text-sm text-slate-700 dark:text-white transition-all focus:ring-2 focus:ring-emerald-500/50">
                                        </div>
                                        
                                        <div class="w-full sm:w-auto">
                                            <label class="text-[10px] font-bold text-slate-400 dark:text-slate-500 mb-1 block uppercase">時間</label>
                                            <div class="flex items-center gap-2 flex-wrap sm:flex-nowrap">
                                                <div class="relative min-w-[90px]">
                                                    <select id="timeInput" class="w-full pl-2 pr-6 py-2 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg text-sm text-slate-700 dark:text-white appearance-none cursor-pointer focus:ring-2 focus:ring-emerald-500/50">
                                                        <!-- JSで生成 -->
                                                    </select>
                                                    <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-3 h-3 text-slate-400 pointer-events-none"></i>
                                                </div>

                                                <!-- 終了時間エリア -->
                                                <div class="flex items-center gap-2" id="endTimeArea">
                                                    <span class="text-slate-400 text-sm hidden" id="tilde">～</span>
                                                    <div class="relative min-w-[90px] hidden" id="endTimeWrapper">
                                                        <select id="endTimeInput" class="w-full pl-2 pr-6 py-2 bg-white dark:bg-slate-600 border border-slate-200 dark:border-slate-500 rounded-lg text-sm text-slate-700 dark:text-white appearance-none cursor-pointer focus:ring-2 focus:ring-emerald-500/50">
                                                            <!-- JSで生成 -->
                                                        </select>
                                                        <i data-lucide="chevron-down" class="absolute right-2 top-2.5 w-3 h-3 text-slate-400 pointer-events-none"></i>
                                                    </div>
                                                    
                                                    <label class="cursor-pointer select-none">
                                                        <input type="checkbox" id="useEndTime" class="sr-only peer" onchange="toggleEndTime()">
                                                        <span class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900/30 px-2 py-1.5 rounded hover:bg-emerald-200 dark:hover:bg-emerald-900/50 transition-colors peer-checked:hidden flex items-center gap-1">
                                                            <i data-lucide="plus" class="w-3 h-3"></i> 終了時間
                                                        </span>
                                                        <span class="hidden peer-checked:flex text-slate-400 hover:text-slate-600 cursor-pointer p-1">
                                                            <i data-lucide="x-circle" class="w-4 h-4"></i>
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <button onclick="addCandidateDate()" id="addBtn" disabled class="h-[38px] px-3 bg-slate-800 dark:bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-slate-700 dark:hover:bg-emerald-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 shadow-md active:scale-95 ml-auto sm:ml-0">
                                            <i data-lucide="plus" class="w-4 h-4"></i> 追加
                                        </button>
                                    </div>

                                    <textarea id="candidateDates" rows="4" placeholder="候補日、または確定日時を入力してください"
                                        class="w-full p-4 bg-white/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-600 rounded-xl text-slate-700 dark:text-white font-mono text-sm shadow-sm transition-all placeholder:text-slate-400 focus:bg-white dark:focus:bg-slate-800"
                                        oninput="updatePreview(); toggleClearBtn()"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. AIチャットモード用設定 (Geminiブランド) -->
                    <div id="customSettings" class="hidden h-full flex flex-col animate-fade-in" style="height: 600px;">
                        <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md rounded-3xl shadow-sm border border-white/60 dark:border-slate-700/50 overflow-hidden flex-1 flex flex-col">
                            <div class="bg-gradient-to-r from-blue-50 to-pink-50 dark:from-slate-800 dark:to-slate-800 px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between flex-shrink-0">
                                 <div class="flex items-center gap-2">
                                    <!-- Geminiロゴ風アイコン -->
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center text-white shadow-md">
                                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex flex-col">
                                        <h2 class="text-base font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-pink-600">Gemini 3.0 Flash</h2>
                                        <span class="text-[10px] text-slate-400 dark:text-slate-500 font-bold leading-none">AI Chat Assistant</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="hidden items-center gap-1.5 cursor-pointer select-none group">
                                        <span class="text-[10px] font-bold text-slate-400 group-hover:text-slate-600 transition-colors uppercase">Thinking</span>
                                        <div class="relative">
                                            <input type="checkbox" id="useThinking" class="sr-only peer" checked>
                                            <div class="w-8 h-4 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-500"></div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- チャットログエリア -->
                            <div id="chatLog" class="flex-1 p-6 overflow-y-auto space-y-4 bg-slate-50/50 dark:bg-slate-900/20">
                                <!-- 初期メッセージ -->
                                <div class="flex items-start gap-3">
                                    <div class="w-8 h-8 rounded-full bg-white border border-slate-100 flex items-center justify-center flex-shrink-0 shadow-sm">
                                        <i data-lucide="sparkles" class="w-4 h-4 text-blue-500"></i>
                                    </div>
                                    <div class="bg-white dark:bg-slate-700 p-3.5 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 dark:text-slate-200 border border-slate-100 dark:border-slate-600 leading-relaxed">
                                        こんにちは！どのようなメールを作成しますか？<br>「来週月曜の午後に電話したい」など、要件を入力してください。
                                    </div>
                                </div>
                            </div>

                            <!-- 入力エリア -->
                            <div class="p-4 bg-white dark:bg-slate-800 border-t border-slate-100 dark:border-slate-700 flex-shrink-0">
                                <div class="relative flex gap-2">
                                    <textarea id="customMessage" placeholder="ここにメッセージを入力..." rows="1"
                                        class="flex-1 pl-4 pr-4 py-3 bg-slate-100 dark:bg-slate-700/50 border-transparent rounded-2xl text-slate-800 dark:text-white resize-none focus:bg-white dark:focus:bg-slate-600 focus:ring-2 focus:ring-blue-100 dark:focus:ring-slate-500 transition-all text-sm"
                                        style="min-height: 48px; max-height: 120px;"></textarea>
                                    <button id="aiGenerateBtn" onclick="handleAIGenerate()" class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-gradient-to-tr from-blue-500 to-pink-500 hover:from-blue-600 hover:to-pink-600 text-white rounded-full shadow-md hover:shadow-lg active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i data-lucide="send-horizontal" class="w-5 h-5 ml-0.5"></i>
                                    </button>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-2 text-center">AI生成中にページを離れないでください</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 右カラム：プレビュー -->
            <div class="lg:col-span-5 space-y-6 lg:sticky lg:top-[5.5rem] self-start">
                
                <!-- Mac風プレビューウィンドウ -->
                <div class="relative group h-[calc(100vh-140px)] min-h-[500px]">
                    <!-- 背景の装飾（グロー効果） -->
                    <div id="previewGlow" class="absolute -inset-1 bg-gradient-to-br from-indigo-400 to-blue-400 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000"></div>
                    
                    <div class="relative bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/60 dark:border-slate-600/50 overflow-hidden transition-colors duration-300 flex flex-col h-full">
                        
                        <!-- Mac風プレビューヘッダー -->
                        <div class="bg-gray-100/80 dark:bg-slate-800/80 border-b border-gray-200 dark:border-slate-700 px-4 py-3 flex items-center justify-between h-12 flex-shrink-0">
                            <div class="flex gap-2 opacity-100 group/btns w-16 flex-shrink-0">
                                <div class="mac-dot mac-close shadow-sm hover:brightness-90 transition-all"></div>
                                <div class="mac-dot mac-minimize shadow-sm hover:brightness-90 transition-all"></div>
                                <div class="mac-dot mac-maximize shadow-sm hover:brightness-90 transition-all"></div>
                            </div>
                            
                            <span id="previewLabel" class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest select-none truncate text-center flex-1 mx-2">
                                AI文章作成プレビュー
                            </span>

                            <div class="flex items-center justify-end gap-2 min-w-[64px] flex-shrink-0">
                                <!-- バリデーションアラート -->
                                <div id="nameAlert" class="hidden flex items-center gap-1.5 text-[10px] font-bold text-white bg-rose-500 px-3 py-1 rounded-full shadow-md animate-bounce-slight whitespace-nowrap">
                                    <i data-lucide="alert-circle" class="w-3 h-3"></i>
                                    <span>入力必須</span>
                                </div>
                                
                                <!-- 履歴操作 (AIモードのみ表示) -->
                                <div id="historyControls" class="hidden flex items-center gap-1 bg-white/50 dark:bg-black/20 rounded-lg p-0.5">
                                    <button onclick="navigateHistory(-1)" id="prevHistoryBtn" class="p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-600 disabled:opacity-30 transition-colors" disabled>
                                        <i data-lucide="chevron-left" class="w-3 h-3"></i>
                                    </button>
                                    <span id="historyCount" class="text-[10px] font-mono text-slate-500 dark:text-slate-400 min-w-[24px] text-center">0/0</span>
                                    <button onclick="navigateHistory(1)" id="nextHistoryBtn" class="p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-600 disabled:opacity-30 transition-colors" disabled>
                                        <i data-lucide="chevron-right" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- テキストエリア (編集可能) -->
                        <div class="flex-1 relative overflow-hidden">
                            <textarea id="generatedText"
                                class="w-full h-full p-6 bg-transparent resize-none font-mono text-sm leading-relaxed focus:outline-none text-slate-700 dark:text-slate-300 selection:bg-pink-100 dark:selection:bg-pink-900/30 overflow-y-auto"></textarea>
                            
                            <!-- AI生成中ローディング -->
                            <div id="aiLoading" class="absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center gap-4 hidden z-20">
                                <div class="w-10 h-10 border-4 border-violet-200 border-t-violet-600 rounded-full animate-spin"></div>
                                <span class="text-xs font-bold text-violet-600 dark:text-violet-400 animate-pulse">AI思考中...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- コピーボタン -->
                    <div class="absolute bottom-6 right-6 z-10">
                        <button onclick="handleCopy()" id="copyBtn" disabled
                            class="flex items-center gap-2 px-6 py-3.5 rounded-full font-bold shadow-lg shadow-pink-500/30 transition-all transform hover:-translate-y-1 active:scale-95 bg-gradient-to-r from-pink-500 to-purple-600 text-white hover:shadow-xl hover:shadow-pink-500/40 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none grayscale disabled:grayscale ring-4 ring-white/30 dark:ring-black/30 backdrop-blur-sm">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                            <span class="tracking-wide" id="copyBtnText">COPY</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        let currentMode = 'custom'; 
        let isGenerating = false;
        let chatHistory = []; 
        let aiDraftHistory = [];
        let aiDraftIndex = -1;
        let aiDraft = "";
        
        const DEFAULT_API_KEY = ""; 

        // 初期化処理
        window.addEventListener('DOMContentLoaded', () => {
            initTimeOptions();
            loadSettings();
            setMode('custom'); 
            
            const chatInput = document.getElementById('customMessage');
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.isComposing) {
                    if (!e.shiftKey) {
                        e.preventDefault();
                        handleAIGenerate();
                    }
                }
            });
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if(this.value === '') this.style.height = '48px'; 
            });

            document.getElementById('dateInput').addEventListener('input', (e) => {
                const btn = document.getElementById('addBtn');
                btn.disabled = !e.target.value;
                if(!e.target.value) btn.classList.add('opacity-50', 'cursor-not-allowed');
                else btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        });

        // 設定の読み込み
        const loadSettings = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            const savedModel = localStorage.getItem('gemini_model_name');
            if (savedKey) document.getElementById('apiKeyInput').value = savedKey;
            if (savedModel) document.getElementById('modelNameInput').value = savedModel;
            updateAIBtnState();
        };

        const updateAIBtnState = () => {
            const btn = document.getElementById('aiGenerateBtn');
            const hasKey = !!(localStorage.getItem('gemini_api_key') || DEFAULT_API_KEY);
            if(btn) {
                btn.disabled = !hasKey;
                btn.title = hasKey ? "AIで生成" : "APIキーを設定してください";
            }
        };

        // 設定の保存
        const saveSettings = () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            const model = document.getElementById('modelNameInput').value.trim();
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model_name', model);
            showToast('設定を保存しました');
            toggleSettingsModal();
            updateAIBtnState();
            updatePreview();
        };

        const clearSettings = () => {
            if(!confirm('設定を削除しますか？')) return;
            localStorage.removeItem('gemini_api_key');
            localStorage.removeItem('gemini_model_name');
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('modelNameInput').value = 'gemini-3-flash-preview';
            showToast('設定を削除しました');
            updateAIBtnState();
        };

        const toggleSettingsModal = () => {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('hidden');
        };

        const showToast = (msg) => {
            const toast = document.getElementById('toast');
            document.getElementById('toastText').textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        };

        // 時間オプション生成
        const initTimeOptions = () => {
            const timeSelect = document.getElementById('timeInput');
            const endTimeSelect = document.getElementById('endTimeInput');
            let options = '';
            
            for (let h = 9; h <= 19; h++) {
                for (let m = 0; m < 60; m += 15) {
                    if (h === 19 && m > 0) break;
                    const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    const isSelected = time === '10:00' ? 'selected' : '';
                    options += `<option value="${time}" ${isSelected}>${time}</option>`;
                }
            }
            timeSelect.innerHTML = options;
            
            let endOptions = '';
            for (let h = 9; h <= 19; h++) {
                for (let m = 0; m < 60; m += 15) {
                    if (h === 19 && m > 0) break;
                    const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    const isSelected = time === '15:00' ? 'selected' : '';
                    endOptions += `<option value="${time}" ${isSelected}>${time}</option>`;
                }
            }
            endTimeSelect.innerHTML = endOptions;
        };

        const toggleEndTime = () => {
            const isChecked = document.getElementById('useEndTime').checked;
            const wrapper = document.getElementById('endTimeWrapper');
            const tilde = document.getElementById('tilde');
            
            if (isChecked) {
                wrapper.classList.remove('hidden');
                tilde.classList.remove('hidden');
            } else {
                wrapper.classList.add('hidden');
                tilde.classList.add('hidden');
            }
        };

        function updateInspectionType(value) {
            document.getElementById('inspectionType').value = value;
            toggleCustomInspection();
            updatePreview();
        }

        if (localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }

        function resetForm() {
            if (!confirm('入力内容をリセットしますか？')) return;

            document.getElementById('customerName').value = '';
            document.getElementById('staffName').value = '畑'; 
            document.getElementById('inspectionType').value = '6か月';
            document.getElementById('customInspectionType').value = '';
            document.getElementById('issueDetail').value = '';
            document.getElementById('needsApology').checked = false;
            
            const visitRadios = document.getElementsByName('visitReason');
            for(const r of visitRadios) if(r.value === '修繕作業') r.checked = true;

            const inspectionRadios = document.getElementsByName('inspectionTypeBtn');
            for(const r of inspectionRadios) if(r.value === '6か月') r.checked = true;

            document.getElementById('dateInput').value = '';
            document.getElementById('timeInput').value = '10:00';
            document.getElementById('endTimeInput').value = '15:00';
            document.getElementById('useEndTime').checked = false;
            toggleEndTime();

            document.getElementById('candidateDates').value = '';
            document.getElementById('customMessage').value = '';
            
            // 履歴クリア
            chatHistory = [];
            aiDraftHistory = [];
            aiDraftIndex = -1;
            aiDraft = "";
            updateHistoryButtons();

            const chatLog = document.getElementById('chatLog');
            chatLog.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-100 flex items-center justify-center flex-shrink-0 shadow-sm">
                        <i data-lucide="sparkles" class="w-4 h-4 text-blue-500"></i>
                    </div>
                    <div class="bg-white dark:bg-slate-700 p-3.5 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 dark:text-slate-200 border border-slate-100 dark:border-slate-600 leading-relaxed">
                        こんにちは！どのようなメールを作成しますか？<br>「来週月曜の午後に電話したい」など、要件を入力してください。
                    </div>
                </div>`;

            document.getElementById('customInspectionWrapper').classList.add('hidden');
            toggleClearBtn();
            setMode('custom');
            updatePreview();
        }

        // モード切替
        function setMode(mode) {
            currentMode = mode;
            
            const activeClass = "group relative flex flex-col items-center justify-center py-3 rounded-xl border-2 transition-all duration-200 bg-white/80 dark:bg-slate-800/80 font-bold shadow-md transform scale-[1.02]";
            const inactiveClass = "group relative flex flex-col items-center justify-center py-3 rounded-xl border transition-all duration-200 bg-white/40 dark:bg-slate-800/40 border-transparent text-slate-500 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-600 hover:bg-white/60 shadow-sm";

            const colors = {
                normal: "border-pink-400 text-pink-600 dark:text-pink-400",
                sms: "border-emerald-400 text-emerald-600 dark:text-emerald-400",
                custom: "border-violet-400 text-violet-600 dark:text-violet-400"
            };

            ['normal', 'sms', 'custom'].forEach(t => {
                const el = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                if(t === mode) {
                    el.className = `${activeClass} ${colors[t]}`;
                } else {
                    el.className = inactiveClass;
                }
            });

            const label = document.getElementById('previewLabel');
            const normalSettings = document.getElementById('normalSettings');
            const customSettings = document.getElementById('customSettings');
            const inspectionCard = document.getElementById('inspectionDetailsCard');
            const bodyBg = document.getElementById('bodyBg');
            const previewGlow = document.getElementById('previewGlow');
            const nameAlert = document.getElementById('nameAlert');
            const historyControls = document.getElementById('historyControls');

            if (mode === 'custom') {
                label.textContent = 'AI文章作成プレビュー';
                normalSettings.classList.add('hidden');
                customSettings.classList.remove('hidden');
                
                bodyBg.className = "bg-gradient-to-br from-indigo-100 via-blue-100 to-sky-100 dark:from-slate-900 dark:via-indigo-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-indigo-400 selection:text-white bg-animate";
                previewGlow.className = "absolute -inset-1 bg-gradient-to-br from-indigo-400 to-blue-400 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000";
                
                nameAlert.classList.add('hidden');
                historyControls.classList.remove('hidden');
                
                if (aiDraft) {
                    document.getElementById('generatedText').value = aiDraft;
                } else {
                    document.getElementById('generatedText').value = "";
                }

            } else {
                normalSettings.classList.remove('hidden');
                customSettings.classList.add('hidden');
                historyControls.classList.add('hidden');
                
                if (mode === 'sms') {
                    label.textContent = '事前確認SMSプレビュー';
                    inspectionCard.classList.add('hidden');
                    bodyBg.className = "bg-gradient-to-br from-emerald-100 via-teal-100 to-cyan-100 dark:from-slate-900 dark:via-emerald-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-emerald-400 selection:text-white bg-animate";
                    previewGlow.className = "absolute -inset-1 bg-gradient-to-br from-emerald-400 to-teal-400 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000";
                } else {
                    label.textContent = '日程調整メールプレビュー';
                    inspectionCard.classList.remove('hidden');
                    bodyBg.className = "bg-gradient-to-br from-pink-300 via-purple-300 to-cyan-300 dark:from-slate-900 dark:via-purple-950 dark:to-slate-900 text-slate-700 dark:text-slate-100 min-h-screen transition-colors duration-500 selection:bg-pink-400 selection:text-white bg-animate";
                    previewGlow.className = "absolute -inset-1 bg-gradient-to-br from-pink-400 to-purple-400 rounded-[20px] opacity-20 blur-xl group-hover:opacity-30 transition duration-1000";
                }
            }

            updatePreview();
        }

        // チャットUI追加
        function addChatMessage(role, text) {
            const chatLog = document.getElementById('chatLog');
            const div = document.createElement('div');
            
            if (role === 'user') {
                div.className = "flex items-end justify-end gap-2 animate-slide-up";
                div.innerHTML = `
                    <div class="bg-indigo-600 text-white p-3.5 rounded-2xl rounded-tr-none shadow-md text-sm max-w-[85%] whitespace-pre-wrap leading-relaxed">${text}</div>
                `;
            } else if (role === 'ai') {
                div.className = "flex items-start gap-3 animate-slide-up";
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-100 flex items-center justify-center flex-shrink-0 shadow-sm">
                        <i data-lucide="sparkles" class="w-4 h-4 text-blue-500"></i>
                    </div>
                    <div class="bg-white dark:bg-slate-700 p-3.5 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 dark:text-slate-200 border border-slate-100 dark:border-slate-600 whitespace-pre-wrap leading-relaxed">${text}</div>
                `;
            } else if (role === 'thinking') {
                div.id = 'thinkingMsg';
                div.className = "flex items-start gap-3 animate-pulse";
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-100 flex items-center justify-center flex-shrink-0 shadow-sm">
                        <i data-lucide="loader-2" class="w-4 h-4 text-slate-400 animate-spin"></i>
                    </div>
                    <div class="text-xs text-slate-400 pt-2 font-bold">Thinking...</div>
                `;
            }
            
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
            lucide.createIcons();
        }

        function removeThinkingMessage() {
            const msg = document.getElementById('thinkingMsg');
            if (msg) msg.remove();
        }

        // 履歴操作機能
        function addToAiHistory(text) {
            aiDraftHistory.push(text);
            aiDraftIndex = aiDraftHistory.length - 1;
            aiDraft = text;
            updateHistoryButtons();
        }

        function navigateHistory(direction) {
            const newIndex = aiDraftIndex + direction;
            if (newIndex >= 0 && newIndex < aiDraftHistory.length) {
                aiDraftIndex = newIndex;
                aiDraft = aiDraftHistory[newIndex];
                document.getElementById('generatedText').value = aiDraft;
                updateHistoryButtons();
            }
        }

        function updateHistoryButtons() {
            const prevBtn = document.getElementById('prevHistoryBtn');
            const nextBtn = document.getElementById('nextHistoryBtn');
            const countLabel = document.getElementById('historyCount');
            
            if (aiDraftHistory.length === 0) {
                countLabel.textContent = "0/0";
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }

            countLabel.textContent = `${aiDraftIndex + 1}/${aiDraftHistory.length}`;
            prevBtn.disabled = (aiDraftIndex <= 0);
            nextBtn.disabled = (aiDraftIndex >= aiDraftHistory.length - 1);
        }

        // Gemini API 呼び出し
        async function handleAIGenerate() {
            const apiKey = localStorage.getItem('gemini_api_key') || DEFAULT_API_KEY;
            if (!apiKey) {
                showToast('APIキーが設定されていません');
                toggleSettingsModal();
                return;
            }

            // Thinkingスイッチ廃止に伴い、常にThinking有効として扱うか、またはモデル自体で対応
            // ここでは常に思考レベルの高いモデルを使用し、プロンプトで制御する
            let model = localStorage.getItem('gemini_model_name') || 'gemini-3-flash-preview';

            const customerName = document.getElementById('customerName').value.trim();
            const staffName = document.getElementById('staffName').value.trim();
            const content = document.getElementById('customMessage').value.trim();

            if (!customerName || !content) {
                showToast('顧客名と要件を入力してください');
                return;
            }

            addChatMessage('user', content);
            document.getElementById('customMessage').value = '';
            document.getElementById('customMessage').style.height = '48px';
            
            addChatMessage('thinking');
            isGenerating = true;
            
            const now = new Date();
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const dateStr = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日(${days[now.getDay()]}) ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

            // systemInstruction (Merged into first content for better compatibility)
            // 400エラー回避のため、systemInstructionをプロンプト本文に統合する
            const systemPrompt = `あなたは住宅メーカーのアフターサポート担当者（AIアシスタント）です。
現在日時: ${dateStr}

【重要：対話相手の認識について】
・今あなたが会話している相手は、このツールを操作している「ユーザー（当社のスタッフ）」です。
・入力フォームにある「顧客名（${customerName} 様）」は、メールの送信先であり、チャットの相手ではありません。
・したがって、チャットの返答でユーザーを「${customerName} 様」と呼んだり、お客様扱いするような挨拶（「お問い合わせありがとうございます」等）は絶対にしないでください。
・ユーザーに対しては「お疲れ様です」「承知いたしました」といった、社内または業務パートナーとしての丁寧な口調で接してください。

【重要：出力形式について】
・作成・修正したメール本文は、その「本文のみ」を \`\`\`email ... \`\`\` というコードブロックで囲んで出力してください。
・ユーザーへの返答、解説、確認事項はコードブロックの外に記述してください。

【重要：メール本文の構成（コードブロック内）】
・宛先：お客様（${customerName} 様）
・差出人：桧家住宅 埼玉北工事部 ${staffName}
・ショートメール（SMS）のため、件名は不要です。
・メールのような形式的な署名（住所や電話番号の羅列など）は不要です。
・名乗りは文頭などで自然に行ってください。`;

            // Thinkingスイッチ廃止のため、常に丁寧な思考プロセスを促すプロンプトを使用
            let promptConstraint = `
制約：
・顧客対応のため、丁寧な言葉遣いで。
・読みやすくなるよう、適切に改行を入れること。
・挨拶から結びまで含める（署名は不要）。
・思考プロセスを活用し、最適な文面を作成してください。`;

            let contents = [];

            // 履歴の先頭にシステムプロンプトを統合する
            if (chatHistory.length === 0) {
                 contents.push({ role: "user", parts: [{ text: systemPrompt + "\n\n" + `要件：${content}\n${promptConstraint}` }] });
            } else {
                // 1. システムプロンプト + 最初のユーザーメッセージ (擬似的に統合)
                const firstMsg = chatHistory[0];
                if (firstMsg.role === 'user') {
                     contents.push({ role: 'user', parts: [{ text: systemPrompt + "\n\n" + firstMsg.text }] });
                } else {
                     // 万が一最初がAIだった場合のフォールバック
                     contents.push({ role: 'user', parts: [{ text: systemPrompt }] });
                     contents.push({ role: 'model', parts: [{ text: firstMsg.text }] });
                }

                // 2. 残りの履歴
                for (let i = 1; i < chatHistory.length; i++) {
                    const msg = chatHistory[i];
                    contents.push({
                        role: msg.role === 'ai' ? 'model' : 'user',
                        parts: [{ text: msg.text }]
                    });
                }
                
                // 3. 今回の入力
                contents.push({ role: "user", parts: [{ text: `要件：${content}\n${promptConstraint}` }] });
            }

            try {
                // systemInstructionプロパティを使わず、contentsに統合して送信
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: contents })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`API Error: ${data.error.message || data.error.code}`);
                }

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    removeThinkingMessage();
                    
                    // 履歴に追加
                    chatHistory.push({ role: 'user', text: content }); 
                    chatHistory.push({ role: 'ai', text: text });
                    
                    // プレビュー更新判定
                    const match = text.match(/```email\s*([\s\S]*?)```/);
                    
                    if (match) {
                        const emailBody = match[1].trim();
                        document.getElementById('generatedText').value = emailBody;
                        addToAiHistory(emailBody);

                        const chatResponse = text.replace(/```email[\s\S]*?```/g, '').trim();
                        if (chatResponse) {
                            addChatMessage('ai', chatResponse);
                        } else {
                             addChatMessage('ai', 'メール本文を作成しました。右側のプレビューをご確認ください。');
                        }
                        showToast('プレビューを更新しました');
                    } else {
                        addChatMessage('ai', text);
                    }
                    
                } else {
                    throw new Error('生成されたテキストが空です');
                }
            } catch (err) {
                console.error(err);
                removeThinkingMessage();
                let errMsg = 'エラーが発生しました。';
                if (err.message.includes('429')) errMsg = '混雑のため制限がかかりました。少し待って再試行してください。';
                if (err.message.includes('404')) errMsg = 'モデルが見つかりません。設定を確認してください。';
                if (err.message.includes('400')) {
                    if (err.message.includes('API key not valid')) {
                        errMsg = 'APIキーが無効です。設定画面から正しいキーを入力してください。';
                        toggleSettingsModal(); // 自動で設定画面を開く
                    } else {
                        errMsg = 'リクエストエラー(400)。モデルを変更するか、入力内容を確認してください。';
                    }
                }
                addChatMessage('ai', `⚠️ ${errMsg}`);
            } finally {
                isGenerating = false;
            }
        }

        async function fetchWithRetry(url, options, retries = 5, backoff = 2000) {
            try {
                const res = await fetch(url, options);
                
                if (res.ok) return res;
                
                const status = res.status;
                if (status === 429 || status >= 500) {
                    throw new Error(`RETRYABLE_ERROR:${status}`);
                }
                
                const errBody = await res.json().catch(() => ({}));
                throw new Error(`API Error: ${status} ${errBody.error?.message || ''}`);

            } catch (err) {
                const isRetryable = err.message.includes('RETRYABLE_ERROR') || err.message.includes('429');
                
                if (retries > 0 && isRetryable) {
                    const waitTime = backoff + Math.random() * 1000;
                    console.log(`API Error (${err.message}). Retrying in ${Math.round(waitTime)}ms... Attempts left: ${retries}`);
                    await new Promise(r => setTimeout(r, waitTime));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                
                throw err;
            }
        }

        function updatePreview() {
            // ... (省略: 既存ロジックは変更なし) ...
            if (currentMode === 'custom') return;
            
            const customerName = document.getElementById('customerName').value.trim();
            const staffName = document.getElementById('staffName').value.trim();
            const nameAlert = document.getElementById('nameAlert');
            const copyBtn = document.getElementById('copyBtn');
            
            if (!customerName || !staffName) {
                if(nameAlert) {
                    nameAlert.classList.remove('hidden');
                    nameAlert.style.display = 'flex';
                }
                if(copyBtn) {
                    copyBtn.disabled = true;
                    copyBtn.classList.add('grayscale');
                }
            } else {
                if(nameAlert) {
                    nameAlert.classList.add('hidden');
                    nameAlert.style.display = 'none';
                }
                if(copyBtn) {
                    copyBtn.disabled = false;
                    copyBtn.classList.remove('grayscale');
                }
            }

            let fullText = "";

            if (currentMode === 'sms') {
                const candidateDates = document.getElementById('candidateDates').value;
                fullText = `${customerName} 様\n\nいつもお世話になっております。桧家住宅の${staffName}です。\n\n次回の訪問日程の確認でご連絡いたしました。\n予定通り、下記日時にお伺いいたします。\n\n${candidateDates.trim() ? `【日時】\n${candidateDates.trim()}` : `【日時】\n（日時を入力してください）`}\n\n当日はよろしくお願いいたします。\n※変更がある場合はお早めにご連絡ください。`;

            } else {
                const inspectionTypeSelect = document.getElementById('inspectionType').value;
                const customInspectionType = document.getElementById('customInspectionType').value;
                let type = inspectionTypeSelect === 'その他' ? customInspectionType : inspectionTypeSelect;
                if (type && !type.includes('点検')) type += '点検';

                const issueDetail = document.getElementById('issueDetail').value;
                const needsApology = document.getElementById('needsApology').checked;
                
                let visitReason = '修繕作業';
                const reasonEls = document.getElementsByName('visitReason');
                for(const r of reasonEls) if(r.checked) visitReason = r.value;

                const candidateDates = document.getElementById('candidateDates').value;

                const greeting = `いつも大変お世話になっております。\n桧家住宅 埼玉北工事部の${staffName}です。`;

                let mainBody = '';
                if (type) mainBody += `先日は、${type}にお立会いいただきありがとうございました。\n`;
                if (issueDetail) {
                    mainBody += `ご指摘いただきました${issueDetail}の件についてご連絡いたしました。\n`;
                }
                if (needsApology) {
                    mainBody += issueDetail ? `点検日からお時間をいただいてしまい、誠に申し訳ございません。\n` : `ご連絡が遅くなりまして、誠に申し訳ございません。\n`;
                }

                const reasonText = visitReason === '現地調査' ? '状況確認（現地調査）' : '修繕作業';
                let proposal = `つきましては、下記日程にて${reasonText}にお伺いしたく存じます。\n\n`;

                if (candidateDates.trim()) {
                    proposal += `【候補日時】\n${candidateDates.trim()}\n\n`;
                    proposal += `上記以外でも、火・水を除く平日・土日の9時～17時の間で調整可能です。\nご都合はいかがでしょうか。`;
                } else {
                    proposal += `恐れ入りますが、火・水を除く平日・土日の9時～17時の間で、\nご都合のよろしい日程を3つほどお知らせいただけますでしょうか。`;
                }

                fullText = `${customerName} 様\n\n${greeting}\n\n${mainBody}\n${proposal}\n\n何卒よろしくお願い申し上げます。\n\n桧家住宅 埼玉北工事部 ${staffName}`;
            }

            document.getElementById('generatedText').value = fullText;
        }

        // ... (以下既存関数) ...
        function toggleCustomInspection() {
            const val = document.getElementById('inspectionType').value;
            const wrapper = document.getElementById('customInspectionWrapper');
            val === 'その他' ? wrapper.classList.remove('hidden') : wrapper.classList.add('hidden');
        }

        function addCandidateDate() {
            const dateVal = document.getElementById('dateInput').value;
            const timeVal = document.getElementById('timeInput').value;
            if (!dateVal) return;
            const date = new Date(dateVal);
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            
            let formatted = `・${date.getMonth() + 1}月${date.getDate()}日(${days[date.getDay()]}) ${timeVal}`;
            
            if(document.getElementById('useEndTime').checked) {
                const endTime = document.getElementById('endTimeInput').value;
                formatted += `～${endTime}`;
            } else {
                formatted += `～`;
            }

            const area = document.getElementById('candidateDates');
            area.value = area.value ? area.value.trim() + '\n' + formatted + '\n' : formatted + '\n';
            updatePreview();
            toggleClearBtn();
        }

        function toggleClearBtn() {
            const val = document.getElementById('candidateDates').value;
            const btn = document.getElementById('clearBtn');
            if(btn) val ? btn.classList.remove('hidden') : btn.classList.add('hidden');
        }

        function clearCandidates() {
            document.getElementById('candidateDates').value = '';
            updatePreview();
            toggleClearBtn();
        }

        function handleCopy() {
            const text = document.getElementById('generatedText').value;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                if (document.execCommand('copy')) showCopiedState();
            } catch (err) {
                console.error(err);
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function showCopiedState() {
            const btn = document.getElementById('copyBtn');
            const btnText = document.getElementById('copyBtnText');
            btn.classList.add('bg-emerald-500', 'text-white', 'scale-110', 'ring-emerald-200');
            btn.classList.remove('from-pink-500', 'to-violet-600', 'ring-white/30');
            btnText.textContent = "COPIED!";
            setTimeout(() => {
                btn.classList.remove('bg-emerald-500', 'text-white', 'scale-110', 'ring-emerald-200');
                btn.classList.add('from-pink-500', 'to-violet-600', 'ring-white/30');
                btnText.textContent = "COPY";
            }, 2000);
        }
    </script>
</body>
</html>
